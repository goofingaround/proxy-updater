name: Update Proxies

permissions:
  contents: write

on:
  push:
    branches:
      - main
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v3

      - name: Fetch raw lists
        run: |
          # Download both files
          curl -s "https://raw.githubusercontent.com/zloi-user/hideip.me/refs/heads/master/https.txt" > raw.txt
          curl -s "https://raw.githubusercontent.com/zloi-user/hideip.me/refs/heads/master/connect.txt" > raw-connect.txt

      - name: Build combined proxies.txt
        run: |
          awk -F':' '{
            country=toupper($3); gsub(/ /,"-",country);
            print "http://" $1 ":" $2 "/#" country "1";
          }' raw.txt > proxies.txt

      - name: Build @@@ file from connect.txt
        run: |
          awk -F':' '{
            country=toupper($3); gsub(/ /,"-",country);
            print "http://" $1 ":" $2 "/#" country "1";
          }' raw-connect.txt > "@@@"

      - name: Split out per-country files
        shell: bash
        run: |
          find . -maxdepth 1 -type f -name "*.txt" ! -name raw.txt ! -name proxies.txt ! -name raw-connect.txt ! -name "@@@" -delete || true

          awk -F':' '
          BEGIN { OFS=""; }
          {
            tag = toupper($3); gsub(/ /, "-", tag);
            fname = tolower($3); gsub(/ /, "-", fname); fname = fname ".txt";
            count[tag]++;
            print "http://"$1":"$2"/#"tag count[tag] >> fname;
          }
          ' raw.txt

      - name: Commit & push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add proxies.txt
          git add "@@@"
          git add *.txt
          git diff --cached --quiet || (git commit -m "Automated update of proxies (combined + per-country + @@@)" && git push)
